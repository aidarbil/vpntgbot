# Инструкция и рекомендации по проекту 3xui-shop

## 1. Введение

**3xui-shop** — это Telegram-бот для автоматизации продажи VPN-подписок через интеграцию с панелью 3X-UI. Проект поддерживает различные платёжные шлюзы, реферальную систему, пробные периоды, промокоды и удобную админ-панель.

---

## 2. Архитектура и структура

- **Бот**: построен на aiogram 3, использует FSM, middlewares, фильтры, роутеры.
- **Сервисы**: бизнес-логика (работа с пользователями, подписками, серверами, оплатой и т.д.).
- **Модели**: ORM-слой для работы с БД (SQLAlchemy).
- **Платёжные шлюзы**: Cryptomus, Heleket, YooKassa, YooMoney, Telegram Stars.
- **Интернационализация**: поддержка ru/en.
- **Docker-окружение**: для быстрого деплоя и изоляции зависимостей.
- **Traefik**: для проксирования и автоматического получения SSL.

---

## 3. Быстрый старт и установка

### 3.1. Требования
- Docker и docker-compose
- Домен для Traefik/SSL

### 3.2. Установка
1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/snoups/3xui-shop.git
   cd 3xui-shop
   ```
2. Скопируйте и настройте конфиги:
   ```bash
   cp plans.example.json plans.json
   cp .env.example .env
   ```
   - В `plans.json` укажите свои тарифы.
   - В `.env` пропишите токены, пароли, домен, данные для 3x-ui и платёжных шлюзов.
3. Соберите и запустите контейнеры:
   ```bash
   docker compose build
   docker compose up -d
   ```
4. Проверьте логи:
   ```bash
   docker compose logs -f
   ```

---

## 4. Настройка 3X-UI и работа с серверами

### 4.1. Настройка 3X-UI
- На сервере с 3x-ui:
  1. Настройте SSL (обязательно!).
  2. Включите сервис подписки на порту 2096 и пути `/user/`.
  3. В .env бота пропишите XUI_USERNAME, XUI_PASSWORD, XUI_SUBSCRIPTION_PORT, XUI_SUBSCRIPTION_PATH.
  4. Рекомендуется отключить шифрование конфигов в 3x-ui.
  5. В настройках inbound используйте только первый для добавления клиентов.

### 4.2. Работа с серверами
- Серверы добавляются через админ-панель бота.
- Можно добавить несколько серверов — новые клиенты будут распределяться автоматически.
- Сервер можно отключить, удалить, проверить его статус.
- Для подключения существующего сервера с уже установленным 3x-ui:
  - Просто добавьте его в пул через админ-панель бота, указав адрес, порт, логин/пароль.
  - Не требуется переустанавливать 3x-ui или удалять пользователей.
  - Важно: бот будет использовать только первый inbound для добавления новых клиентов.
  - Старые клиенты, добавленные вручную, не будут видны боту, но не мешают работе.

---

## 5. Рекомендации по эксплуатации и безопасности
- Храните все секреты только в .env, не публикуйте их в репозитории.
- Используйте HTTPS/SSL для всех серверов.
- Регулярно делайте резервные копии БД (есть функция в админ-панели).
- Следите за обновлениями зависимостей и самого бота.
- Добавьте мониторинг (Prometheus, Alertmanager) и ротацию логов.
- Настройте CI/CD для автоматической проверки и деплоя.

---

## 6. Советы по улучшению и развитию
- Разбивайте крупные модули на более мелкие (по 300-500 строк).
- Добавьте docstring к основным классам и функциям.
- Реализуйте тесты (юнит и интеграционные).
- Проверьте валидацию всех входных данных.
- Добавьте централизованный обработчик ошибок.
- Улучшайте тексты сообщений для пользователей.

---

## 7. FAQ

**Вопрос:** Можно ли подключить существующий сервер с 3x-ui, на котором уже есть пользователи?

**Ответ:** Да, можно! Просто добавьте сервер в пул через админ-панель бота, указав его параметры. Бот будет работать с этим сервером через API 3x-ui, добавлять новых клиентов, управлять подписками и т.д. Существующие пользователи на сервере не мешают, но бот их не видит и не управляет ими.

---


